<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ダーツで電車旅行先決定（フルCSV対応）</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  #map { height: 90vh; width: 100%; }
  #dartBtn { padding: 10px 20px; font-size: 16px; margin: 10px; }
</style>
</head>
<body>
<h2>ダーツで電車旅行先を決めよう！</h2>
<button id="dartBtn">ダーツを投げる</button>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Leaflet地図初期化（東京駅付近）
const map = L.map('map').setView([35.681, 139.767], 5);

// OSMタイル
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// GitHub raw CSV URL（要変更）
const csvURL = 'https://raw.githubusercontent.com/takaama09/takaama_homepage/main/station_test.csv';

// ダーツボタン
document.getElementById('dartBtn').addEventListener('click', async () => {
    try {
        // CSV読み込み（Lazy Load）
        const response = await fetch(csvURL);
        if (!response.ok) throw new Error('CSV読み込み失敗');
        const data = await response.text();

        // ヘッダ除去
        const rows = data.split('\n').slice(1);

        // 必要な列だけ抽出
        const stations = rows.map(row => {
            const cols = row.split(','); // カンマ区切り
            return {
                name: cols[2],               // station_name
                lon: parseFloat(cols[9]),    // lon
                lat: parseFloat(cols[10])    // lat
            };
        }).filter(s => !isNaN(s.lat) && !isNaN(s.lon));

        if (stations.length === 0) {
            alert('駅データが存在しません');
            return;
        }

        // ランダム駅を選択
        const randomStation = stations[Math.floor(Math.random() * stations.length)];

        // マーカー表示
        L.marker([randomStation.lat, randomStation.lon])
          .addTo(map)
          .bindPopup(`<b>${randomStation.name}</b>`).openPopup();

        // 地図中心を移動
        map.setView([randomStation.lat, randomStation.lon], 12);

    } catch (err) {
        console.error(err);
        alert('CSVの読み込み中にエラーが発生しました');
    }
});
</script>
</body>
</html>
