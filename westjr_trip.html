<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>JR経路探索</title>
</head>
<body>

<h2>JR西日本 最短経路探索</h2>

開始駅: <input id="start" value="大阪">
ゴール駅: <input id="goal" value="姫路">
<button onclick="run()">探索</button>

<pre id="result"></pre>

<script>
// CSV URL
const lineURL = 'https://raw.githubusercontent.com/takaama09/takaama_homepage/station/line.csv';
const stationURL = 'https://raw.githubusercontent.com/takaama09/takaama_homepage/station/station.csv';
const joinURL = 'https://raw.githubusercontent.com/takaama09/takaama_homepage/station/join.csv';

// CSV 読み込み
async function loadCSV(url) {
  const text = await fetch(url).then(r => r.text());
  const lines = text.trim().split('\n');
  const header = lines[0].split(',');
  return lines.slice(1).map(l => {
    const obj = {};
    l.split(',').forEach((v,i) => obj[header[i]] = v);
    return obj;
  });
}

// BFS
function bfs(adj, start, goal) {
  const q = [start];
  const prev = {};
  prev[start] = null;

  while (q.length) {
    const cur = q.shift();
    if (cur === goal) break;
    for (const nxt of adj[cur] || []) {
      if (!(nxt in prev)) {
        prev[nxt] = cur;
        q.push(nxt);
      }
    }
  }

  if (!(goal in prev)) return null;

  const path = [];
  for (let v = goal; v !== null; v = prev[v]) path.push(v);
  return path.reverse();
}

async function run() {
  const result = document.getElementById("result");
  result.textContent = "読み込み中…";

  const [lines, stations, joins] = await Promise.all([
    loadCSV(lineURL),
    loadCSV(stationURL),
    loadCSV(joinURL)
  ]);

  // station_cd → station_g_cd
  const cdToG = {};
  stations.forEach(s => {
    cdToG[String(s.station_cd)] = String(s.station_g_cd);
  });

  // station_g_cd → station_name
  const gToName = {};
  stations.forEach(s => {
    if (!(s.station_g_cd in gToName)) {
      gToName[String(s.station_g_cd)] = s.station_name;
    }
  });

  // 駅名 → station_g_cd
  const nameToG = {};
  Object.entries(gToName).forEach(([g,n]) => nameToG[n] = g);

  // JR西日本の line_cd
  const jrLines = new Set(
    lines.filter(l => l.company_cd === "4").map(l => l.line_cd)
  );

  // 隣接リスト
  const adj = {};
  joins.forEach(j => {
    if (!jrLines.has(j.line_cd)) return;
    const a = cdToG[j.station_cd1];
    const b = cdToG[j.station_cd2];
    if (!a || !b || a === b) return;

    adj[a] = adj[a] || [];
    adj[b] = adj[b] || [];
    adj[a].push(b);
    adj[b].push(a);
  });

  const startName = document.getElementById("start").value;
  const goalName = document.getElementById("goal").value;

  const start = nameToG[startName];
  const goal = nameToG[goalName];

  if (!start || !goal) {
    result.textContent = "駅名が見つかりません";
    return;
  }

  const path = bfs(adj, start, goal);
  if (!path) {
    result.textContent = "経路が見つかりません";
    return;
  }

  const names = path.map(g => gToName[g]);
  result.textContent =
    `ゴール駅: ${goalName}\n\n経路:\n` +
    names.join(" → ");
}
</script>

</body>
</html>
