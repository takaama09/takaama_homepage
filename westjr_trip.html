<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>JR西日本 最短経路テスト</title>
<style>
body { font-family: sans-serif; }
pre { background: #f5f5f5; padding: 10px; }
</style>
</head>
<body>

<h2>甲南山手 → ランダムJR西日本駅</h2>
<button id="run">実行</button>

<pre id="output">ここに結果が表示されます</pre>

<script>
// =====================
// CSV URL
// =====================
const lineURL = 'https://raw.githubusercontent.com/takaama09/takaama_homepage/station/line.csv';
const stationURL = 'https://raw.githubusercontent.com/takaama09/takaama_homepage/station/station.csv';
const joinURL = 'https://raw.githubusercontent.com/takaama09/takaama_homepage/station/join.csv';

// =====================
// CSV読み込み
// =====================
async function loadCSV(url) {
    const text = await fetch(url).then(r => r.text());
    const lines = text.trim().split('\n');
    const header = lines[0].split(',');
    return lines.slice(1).map(l => {
        const cols = l.split(',');
        const obj = {};
        header.forEach((h, i) => obj[h] = cols[i]);
        return obj;
    });
}

// =====================
// BFS 最短経路
// =====================
function bfsShortestPath(adj, start, goal) {
    const visited = new Set();
    const queue = [[start]];

    while (queue.length > 0) {
        const path = queue.shift();
        const node = path[path.length - 1];

        if (node === goal) return path;

        if (!visited.has(node)) {
            visited.add(node);
            for (const next of (adj[node] || [])) {
                queue.push([...path, next]);
            }
        }
    }
    return null;
}

// =====================
// メイン
// =====================
document.getElementById("run").onclick = async () => {
    const output = document.getElementById("output");
    output.textContent = "計算中…";

    const station = await loadCSV(stationURL);
    const line = await loadCSV(lineURL);
    const join = await loadCSV(joinURL);

    const JR_COMPANY_CD = "4";

    // JR西日本の路線
    const jrLines = new Set(
        line.filter(l => l.company_cd === JR_COMPANY_CD)
            .map(l => l.line_cd)
    );

    const jrJoins = join.filter(j => jrLines.has(j.line_cd));

    // station_cd → station_g_cd
    const stationCdToG = {};
    station.forEach(s => stationCdToG[s.station_cd] = s.station_g_cd);

    // station_g_cd → 駅名
    const stationGToName = {};
    station.forEach(s => {
        if (!(s.station_g_cd in stationGToName)) {
            stationGToName[s.station_g_cd] = s.station_name;
        }
    });

    // 隣接リスト
    const adj = {};
    jrJoins.forEach(r => {
        const c1 = r.station_cd1;
        const c2 = r.station_cd2;
        if (!(c1 in stationCdToG) || !(c2 in stationCdToG)) return;

        const g1 = stationCdToG[c1];
        const g2 = stationCdToG[c2];
        if (g1 === g2) return;

        adj[g1] ??= new Set();
        adj[g2] ??= new Set();
        adj[g1].add(g2);
        adj[g2].add(g1);
    });

    // Set → Array
    for (const k in adj) adj[k] = Array.from(adj[k]);

    // スタート
    const startG = "1160308";

    // ランダムゴール
    const candidates = Object.keys(adj).filter(x => x !== startG);
    let path = null;
    let goal = null;

    while (!path) {
        goal = candidates[Math.floor(Math.random() * candidates.length)];
        path = bfsShortestPath(adj, startG, goal);
    }

    // 表示
    let text = "最短経路：\n";
    path.forEach(g => {
        text += stationGToName[g] + "\n";
    });

    text += `\nスタート: ${stationGToName[startG]} (${startG})`;
    text += `\nゴール: ${stationGToName[goal]} (${goal})`;

    output.textContent = text;
};
</script>

</body>
</html>
