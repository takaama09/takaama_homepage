<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>JR西日本 最短ルート探索</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  #map { height: 80vh; width: 100%; }
  #info { padding:10px; font-family:sans-serif; }
</style>
</head>
<body>
<h2>JR西日本 最短ルート探索</h2>
<div id="info"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([35.5, 135], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// CSV URL
const stationURL = 'https://raw.githubusercontent.com/takaama09/takaama_homepage/main/station/station.csv';
const joinURL    = 'https://raw.githubusercontent.com/takaama09/takaama_homepage/main/station/join.csv';
const lineURL    = 'https://raw.githubusercontent.com/takaama09/takaama_homepage/main/station/line.csv';

// 最寄駅の station_g_cd
const start_gcd = '1160308';

(async () => {
    try {
        const [stationRes, joinRes, lineRes] = await Promise.all([
            fetch(stationURL), fetch(joinURL), fetch(lineURL)
        ]);
        const stationText = await stationRes.text();
        const joinText = await joinRes.text();
        const lineText = await lineRes.text();

        // CSVを2次元配列に
        function parseCSV(text){ return text.replace(/\r/g,'').split('\n').map(r=>r.split(',')); }

        const stationData = parseCSV(stationText);
        const joinData = parseCSV(joinText);
        const lineData = parseCSV(lineText);

        // JR西日本の路線
        const jrwestLines = new Set(lineData.slice(1)
            .filter(r => parseInt(r[1])===4)
            .map(r => r[0]));

        // station_g_cd -> station_cd[]
        const gcd_to_cd = {};
        // station_cd -> {name, lat, lon, gcd}
        const stationMap = {};
        for(let i=1;i<stationData.length;i++){
            const row = stationData[i];
            const line_cd = row[5];
            const company_cd = lineData.find(r=>r[0]===line_cd)?.[1];
            if(!jrwestLines.has(line_cd)) continue;
            const station_cd = row[0].trim();
            const station_gcd = row[1].trim();
            const name = row[2].trim();
            const lat = parseFloat(row[10]);
            const lon = parseFloat(row[9]);
            if(!gcd_to_cd[station_gcd]) gcd_to_cd[station_gcd] = [];
            gcd_to_cd[station_gcd].push(station_cd);
            stationMap[station_cd] = {name, lat, lon, gcd: station_gcd};
        }

        // graph 作成（station_g_cdベース）
        const graph = {};
        for(let i=1;i<joinData.length;i++){
            const s1 = joinData[i][1].trim();
            const s2 = joinData[i][2].trim();
            if(!stationMap[s1] || !stationMap[s2]) continue;
            const g1 = stationMap[s1].gcd;
            const g2 = stationMap[s2].gcd;
            if(g1===g2) continue;
            if(!graph[g1]) graph[g1]=new Set();
            if(!graph[g2]) graph[g2]=new Set();
            graph[g1].add(g2);
            graph[g2].add(g1);
        }

        // graphのSetを配列に変換
        for(let k in graph) graph[k] = Array.from(graph[k]);

        // ランダムに目的駅を選ぶ（startと違うもの）
        const gcdList = Object.keys(graph).filter(g=>g!==start_gcd);
        const goal_gcd = gcdList[Math.floor(Math.random()*gcdList.length)];

        document.getElementById('info').innerHTML = `最寄駅: ${start_gcd} <br> 目的駅: ${goal_gcd}`;

        // BFSで最短経路探索
        function bfs(graph, start, goal){
            const queue = [[start]];
            const visited = new Set([start]);
            while(queue.length>0){
                const path = queue.shift();
                const node = path[path.length-1];
                if(node===goal) return path;
                for(const neigh of graph[node] || []){
                    if(!visited.has(neigh)){
                        visited.add(neigh);
                        queue.push([...path, neigh]);
                    }
                }
            }
            return null;
        }

        const route = bfs(graph, start_gcd, goal_gcd);
        if(!route) alert('経路が見つかりませんでした');
        else{
            const names = route.map(gcd=>{
                const cds = gcd_to_cd[gcd];
                return stationMap[cds[0]].name;
            });
            document.getElementById('info').innerHTML += `<br> 経路: ${names.join(' → ')}`;

            // 地図に駅マーカー
            route.forEach(gcd=>{
                const cds = gcd_to_cd[gcd];
                const cd = cds[0];
                const s = stationMap[cd];
                L.circleMarker([s.lat, s.lon], {radius:5, color:'blue'}).addTo(map)
                  .bindPopup(s.name);
            });

            // ルートを赤線で
            const latlngs = route.map(gcd=>{
                const cds = gcd_to_cd[gcd];
                const cd = cds[0];
                const s = stationMap[cd];
                return [s.lat, s.lon];
            });
            L.polyline(latlngs,{color:'red',weight:4}).addTo(map);
            map.fitBounds(latlngs);
        }

    } catch(e){ console.error(e); alert('読み込みエラー'); }
})();
</script>
</body>
</html>
