<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>JR西日本 最短経路テスト</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: sans-serif; }
  #result { white-space: pre-line; font-size: 16px; }
</style>
</head>
<body>

<h2>JR西日本：最短経路探索</h2>
<div id="result">計算中...</div>

<script>
const stationURL = 'https://raw.githubusercontent.com/takaama09/takaama_homepage/main/station/station.csv';
const lineURL    = 'https://raw.githubusercontent.com/takaama09/takaama_homepage/main/station/line.csv';
const joinURL    = 'https://raw.githubusercontent.com/takaama09/takaama_homepage/main/station/join.csv';

(async () => {
  const resultDiv = document.getElementById('result');

  const [stationText, lineText, joinText] = await Promise.all([
    fetch(stationURL).then(r => r.text()),
    fetch(lineURL).then(r => r.text()),
    fetch(joinURL).then(r => r.text())
  ]);

  // ===== JR西日本の路線 =====
  const jrLines = new Set();
  lineText.replace(/\r/g,'').split('\n').slice(1).forEach(row => {
    const c = row.split(',');
    if (c[1] === '4') jrLines.add(c[0]);
  });

  // ===== station_cd → station_g_cd =====
  const stationCdToG = {};
  // station_g_cd → 駅名
  const stationGToName = {};

  stationText.replace(/\r/g,'').split('\n').slice(1).forEach(row => {
    const c = row.split(',');
    if (c.length < 6) return;

    const station_cd = c[0];
    const station_g_cd = c[1];
    const name = c[2];
    const line_cd = c[5];

    if (!jrLines.has(line_cd)) return;

    stationCdToG[station_cd] = station_g_cd;
    if (!stationGToName[station_g_cd]) {
      stationGToName[station_g_cd] = name;
    }
  });

  // ===== 隣接リスト作成 =====
  const adj = {};

  joinText.replace(/\r/g,'').split('\n').slice(1).forEach(row => {
    const c = row.split(',');
    const s1 = c[0];
    const s2 = c[1];
    const line_cd = c[2];

    if (!jrLines.has(line_cd)) return;
    if (!(s1 in stationCdToG) || !(s2 in stationCdToG)) return;

    const g1 = stationCdToG[s1];
    const g2 = stationCdToG[s2];
    if (g1 === g2) return;

    adj[g1] ??= new Set();
    adj[g2] ??= new Set();
    adj[g1].add(g2);
    adj[g2].add(g1);
  });

  // ===== BFS =====
  function bfsShortestPath(adj, start, goal) {
    const visited = new Set();
    const queue = [[start]];

    while (queue.length) {
      const path = queue.shift();
      const node = path[path.length - 1];

      if (node === goal) return path;
      if (visited.has(node)) continue;

      visited.add(node);
      for (const n of adj[node] ?? []) {
        queue.push([...path, n]);
      }
    }
    return null;
  }

  // ===== 実行 =====
  const start = '1160308'; // 甲南山手
  const allStations = Object.keys(adj);
  const goal = allStations[Math.floor(Math.random() * allStations.length)];

  const path = bfsShortestPath(adj, start, goal);

  if (!path) {
    resultDiv.textContent = '経路が見つかりませんでした';
    return;
  }

  let out = '最短経路：\n';
  path.forEach(g => {
    out += '・' + stationGToName[g] + '\n';
  });

  out += `\nスタート: ${stationGToName[start]} (${start})`;
  out += `\nゴール: ${stationGToName[goal]} (${goal})`;

  resultDiv.textContent = out;
})();
</script>

</body>
</html>
