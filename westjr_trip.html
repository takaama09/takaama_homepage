<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>JR西日本経路探索</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  #map { height: 80vh; width: 100%; margin-bottom: 1em;}
  #info { font-size: 16px; }
</style>
</head>
<body>
<h2>JR西日本 経路探索</h2>
<div id="map"></div>
<div id="info"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([34.7, 135.5], 9);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// CSV URL（GitHub等にアップロードしておく）
const stationURL = 'station.csv';        // 駅情報
const graphURL = 'graph_gcode.csv';      // 隣接駅グラフ（駅グループコード）
// 最寄駅（例）
const startStationCode = 1160308;

(async () => {
    // CSV読み込み
    async function fetchCSV(url) {
        const res = await fetch(url);
        const text = await res.text();
        const lines = text.replace(/\r/g,'').split('\n').filter(l=>l);
        const rows = lines.map(l => l.split(',').map(c=>c.trim()));
        return rows;
    }

    const stationData = await fetchCSV(stationURL);
    const graphData   = await fetchCSV(graphURL);

    // station_g_cd → {name, lat, lon} マップ
    const stationMap = {};
    stationData.slice(1).forEach(row=>{
        const code = row[0];   // station_cd
        const gcode = row[1];  // station_g_cd
        const name = row[2];
        const lon = parseFloat(row[9]);
        const lat = parseFloat(row[10]);
        if(!stationMap[gcode]) stationMap[gcode] = {name, lat, lon, codes: [code]};
        else stationMap[gcode].codes.push(code);
    });

    // graph 作成（駅グループコード）
    const graph = {};
    graphData.forEach(row=>{
        const gcode = row[0];
        const neighbors = row.slice(1).filter(c=>c);
        graph[gcode] = neighbors;
    });

    // 最寄駅の station_g_cd を取得
    let startGcd = null;
    for(let g in stationMap){
        if(stationMap[g].codes.includes(startStationCode)){
            startGcd = g;
            break;
        }
    }
    if(!startGcd){ alert('最寄駅が見つかりません'); return; }

    // JR西日本の駅リストからランダムに1駅選ぶ（最寄駅以外）
    const jrWestGcodes = Object.keys(stationMap).filter(g=>g !== startGcd);
    const goalGcd = jrWestGcodes[Math.floor(Math.random() * jrWestGcodes.length)];

    // BFS で最短経路探索
    function bfsPath(graph, start, goal){
        const queue = [[start]];
        const visited = new Set([start]);
        while(queue.length){
            const path = queue.shift();
            const node = path[path.length-1];
            if(node === goal) return path;
            for(const neighbor of graph[node] || []){
                if(!visited.has(neighbor)){
                    visited.add(neighbor);
                    queue.push([...path, neighbor]);
                }
            }
        }
        return null;
    }

    const route = bfsPath(graph, startGcd, goalGcd);
    if(!route){
        alert('経路が見つかりませんでした');
        return;
    }

    // 地図に駅マーカー
    for(const g in stationMap){
        const s = stationMap[g];
        L.circleMarker([s.lat, s.lon], {radius:4, color:'blue'}).addTo(map)
            .bindPopup(s.name);
    }

    // 経路を赤線で描画
    const latlngs = route.map(g => [stationMap[g].lat, stationMap[g].lon]);
    L.polyline(latlngs, {color:'red', weight:4}).addTo(map);
    map.fitBounds(latlngs);

    // サイトに経路表示
    const infoDiv = document.getElementById('info');
    infoDiv.innerHTML = `<b>最寄駅:</b> ${stationMap[startGcd].name}<br>
                         <b>目的駅:</b> ${stationMap[goalGcd].name}<br>
                         <b>経由駅:</b> ${route.map(g=>stationMap[g].name).join(' → ')}`;

})();
</script>
</body>
</html>

