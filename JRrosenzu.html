<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>JR路線図</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  #map { height: 90vh; width: 100%; }
</style>
</head>
<body>
<h2>JR路線図を地図上に表示するサイトです！</h2>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([36, 138], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// CSVのURL（例：GitHub rawなど）
const lineURL = 'https://raw.githubusercontent.com/takaama09/takaama_homepage/refs/heads/main/station/line.csv';
const stationURL = 'https://raw.githubusercontent.com/takaama09/takaama_homepage/refs/heads/main/station/station.csv';
const joinURL = 'https://raw.githubusercontent.com/takaama09/takaama_homepage/refs/heads/main/station/join.csv';


(async () => {
    try {
        const [lineRes, stationRes, joinRes] = await Promise.all([
            fetch(lineURL), fetch(stationURL), fetch(joinURL)
        ]);
        const lineData = await lineRes.text();
        const stationData = await stationRes.text();
        const joinData = await joinRes.text();

        // line_cd -> company_cdマップ作成
        const lineCompanyMap = {};
        lineData.split('\n').slice(1).forEach(row => {
            const cols = row.split(',').map(c => c.trim());
            const line_cd = cols[0];
            const company_cd = parseInt(cols[1]);
            lineCompanyMap[line_cd] = company_cd;
        });

        // 駅情報作成（JRのみ company_cd 1~6）
        const stationsMap = {};
        stationData.split('\n').slice(1).forEach(row => {
            const cols = row.split(',').map(c => c.trim());
            const code = cols[0];
            const name = cols[2];
            const lat = parseFloat(cols[10]);
            const lon = parseFloat(cols[9]);
            const line_cd = cols[5];
            const e_status = parseInt(cols[13]);

            if (!code || !name || isNaN(lat) || isNaN(lon)) return;
            if (!lineCompanyMap[line_cd]) return;
            const company_cd = lineCompanyMap[line_cd];
            if (company_cd < 1 || company_cd > 6) return;
            if (e_status !== 0) return;      // 運用中のみ


            stationsMap[code] = {name, lat, lon};
        });

        // 隣接駅グラフ作成
        const graph = {};
        joinData.split('\n').slice(1).forEach(row => {
            const cols = row.split(',').map(c => c.trim());
            const s1 = cols[1], s2 = cols[2];
            if (!stationsMap[s1] || !stationsMap[s2]) return;
            if (!graph[s1]) graph[s1] = [];
            if (!graph[s2]) graph[s2] = [];
            graph[s1].push(s2);
            graph[s2].push(s1);
        });

        // 地図に全駅マーカーと路線エッジ表示
        Object.keys(stationsMap).forEach(code => {
            const s = stationsMap[code];
            L.circleMarker([s.lat, s.lon], {radius:4, color:'blue'}).addTo(map)
                .bindPopup(s.name);
            const neighbors = graph[code] || [];
            neighbors.forEach(ncode => {
                // 双方向エッジで二重表示しないようにコード順で判定
                if(code < ncode) {
                    const n = stationsMap[ncode];
                    L.polyline([[s.lat,s.lon],[n.lat,n.lon]], {color:'red'}).addTo(map);
                }
            });
        });

        map.fitBounds(Object.values(stationsMap).map(s => [s.lat, s.lon]));

        alert('JR路線図表示完了！駅をクリックすると名前が確認できます');

    } catch (err) {
        console.error(err);
        alert('CSV読み込みまたは路線図作成中にエラー発生');
    }
})();
</script>
</body>
</html>


